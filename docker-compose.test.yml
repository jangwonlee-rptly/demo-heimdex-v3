# Docker Compose configuration for running tests
# Usage: docker compose -f docker-compose.test.yml up --build

services:
  # API Tests
  api-test:
    build:
      context: .
      dockerfile: ./services/api/Dockerfile.test
    environment:
      # Mock environment variables for tests
      # These don't need to be real since tests mock external services
      SUPABASE_URL: "https://test.supabase.co"
      SUPABASE_ANON_KEY: "test-anon-key"
      SUPABASE_SERVICE_ROLE_KEY: "test-service-role-key"
      SUPABASE_JWT_SECRET: "test-jwt-secret"
      DATABASE_URL: "postgresql://test:test@localhost:5432/test"
      REDIS_URL: "redis://localhost:6379/0"
      OPENAI_API_KEY: "test-openai-key"
      API_CORS_ORIGINS: "http://localhost:3000"

      # Pytest specific settings
      PYTEST_ADDOPTS: "-v --cov=src --cov-report=term-missing --cov-report=html"
    volumes:
      # Mount source code for development
      - ./services/api/src:/app/src:ro
      - ./services/api/tests:/app/tests:ro
      # Mount coverage output directory
      - ./services/api/htmlcov:/app/htmlcov
    command: pytest
    profiles:
      - test

  # Worker Tests (when you add them later)
  worker-test:
    build:
      context: .
      dockerfile: ./services/worker/Dockerfile.test
    environment:
      SUPABASE_URL: "https://test.supabase.co"
      SUPABASE_SERVICE_ROLE_KEY: "test-service-role-key"
      DATABASE_URL: "postgresql://test:test@localhost:5432/test"
      REDIS_URL: "redis://localhost:6379/0"
      OPENAI_API_KEY: "test-openai-key"
      TEMP_DIR: "/tmp/heimdex"
    volumes:
      - ./services/worker/src:/app/src:ro
      - ./services/worker/tests:/app/tests:ro
    command: pytest
    profiles:
      - test
      - worker-test
