<!DOCTYPE html>
<html>
<head>
    <title>Storage Upload Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase Storage Upload Debug</h1>

    <div>
        <h3>1. Check Authentication</h3>
        <button onclick="checkAuth()">Check Auth Status</button>
        <pre id="auth-result"></pre>
    </div>

    <div>
        <h3>2. Test Upload</h3>
        <input type="file" id="fileInput" />
        <button onclick="testUpload()">Test Upload</button>
        <pre id="upload-result"></pre>
    </div>

    <script>
        const SUPABASE_URL = 'https://oxmfngfqmedbzgknyijj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94bWZuZ2ZxbWVkYnpna255aWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyOTMyNzksImV4cCI6MjA3ODg2OTI3OX0.9d3Xm2BfuO6kkaTMhDktYqTN667lXDdusB8ICyO35hc';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkAuth() {
            const resultEl = document.getElementById('auth-result');
            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    resultEl.textContent = '‚ùå Error: ' + JSON.stringify(error, null, 2);
                    return;
                }

                if (!session) {
                    resultEl.textContent = '‚ùå Not authenticated. Please log in first at http://localhost:3000/login';
                    return;
                }

                resultEl.textContent = '‚úÖ Authenticated!\n\n' + JSON.stringify({
                    user_id: session.user.id,
                    email: session.user.email,
                    token_expires: new Date(session.expires_at * 1000).toLocaleString()
                }, null, 2);
            } catch (err) {
                resultEl.textContent = '‚ùå Exception: ' + err.message;
            }
        }

        async function testUpload() {
            const resultEl = document.getElementById('upload-result');
            const fileInput = document.getElementById('fileInput');

            if (!fileInput.files || !fileInput.files[0]) {
                resultEl.textContent = '‚ùå Please select a file first';
                return;
            }

            const file = fileInput.files[0];
            resultEl.textContent = `üì§ Uploading ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)...\n`;

            try {
                // Check auth first
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    resultEl.textContent = '‚ùå Not authenticated. Please log in at http://localhost:3000/login';
                    return;
                }

                const userId = session.user.id;
                const storagePath = `${userId}/test-${Date.now()}.${file.name.split('.').pop()}`;

                resultEl.textContent += `üìç Path: ${storagePath}\n`;
                resultEl.textContent += `üîë User ID: ${userId}\n\n`;

                // Attempt upload
                const { data, error } = await supabase.storage
                    .from('videos')
                    .upload(storagePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    resultEl.textContent += '‚ùå Upload failed:\n' + JSON.stringify(error, null, 2);

                    // Additional debugging
                    resultEl.textContent += '\n\nüîç Debug Info:\n';
                    resultEl.textContent += `- Error name: ${error.name}\n`;
                    resultEl.textContent += `- Error message: ${error.message}\n`;
                    resultEl.textContent += `- Status code: ${error.statusCode || 'N/A'}\n`;
                    return;
                }

                resultEl.textContent += '‚úÖ Upload successful!\n' + JSON.stringify(data, null, 2);

                // Clean up
                await supabase.storage.from('videos').remove([storagePath]);
                resultEl.textContent += '\n\nüóëÔ∏è Test file cleaned up';

            } catch (err) {
                resultEl.textContent += '\n‚ùå Exception: ' + err.message + '\n' + err.stack;
            }
        }
    </script>
</body>
</html>
