FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Set working directory
WORKDIR /app

# Copy dependency files
COPY services/worker/pyproject.toml ./

# Install dependencies including dev dependencies (pytest)
RUN uv pip install --system \
    dramatiq[redis]>=1.15.0 \
    redis>=5.0.0 \
    psycopg[binary]>=3.1.0 \
    supabase>=2.3.0 \
    openai>=1.10.0 \
    scenedetect[opencv]>=0.6.2 \
    opencv-python>=4.8.0 \
    numpy>=1.24.0 \
    pillow>=10.0.0 \
    pydantic>=2.5.0 \
    pydantic-settings>=2.1.0 \
    opensearch-py>=2.4.0 \
    torch>=2.0.0 \
    open-clip-torch>=2.20.0 \
    pytest>=7.4.0 \
    pytest-asyncio>=0.21.0

# Copy shared libraries
COPY libs/ ./libs/

# Copy application code
COPY services/worker/src/ ./src/

# Copy tests
COPY services/worker/tests/ ./tests/

# Create temp directory
RUN mkdir -p /tmp/heimdex

# Set Python path
ENV PYTHONPATH=/app

# Run pytest
CMD ["pytest", "-v"]
