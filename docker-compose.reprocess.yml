# Docker Compose configuration for testing the embedding reprocessing pipeline
# This file is used to test the full reprocessing workflow with real services
#
# Usage:
#   # Start services
#   docker compose -f docker-compose.reprocess.yml up -d redis worker
#
#   # Run CLI reprocessing for a single video
#   docker compose -f docker-compose.reprocess.yml run --rm cli-reprocess \
#     python -m src.scripts.reprocess_embeddings_cli --scope video --video-id <uuid>
#
#   # Run CLI reprocessing for all videos
#   docker compose -f docker-compose.reprocess.yml run --rm cli-reprocess \
#     python -m src.scripts.reprocess_embeddings_cli --scope all
#
#   # Test via API endpoint
#   docker compose -f docker-compose.reprocess.yml up -d redis api
#   curl -X POST http://localhost:8000/v1/admin/reprocess-embeddings \
#     -H "Content-Type: application/json" \
#     -H "Authorization: Bearer <token>" \
#     -d '{"scope": "all", "force": false}'

version: '3.8'

services:
  # Redis broker
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Worker service for processing reprocessing jobs
  worker:
    build:
      context: .
      dockerfile: services/worker/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}
      - EMBEDDING_HMAC_SECRET=${EMBEDDING_HMAC_SECRET:-}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      - OPENSEARCH_URL=${OPENSEARCH_URL:-}
      - CLIP_ENABLED=${CLIP_ENABLED:-false}
      - CLIP_INFERENCE_BACKEND=${CLIP_INFERENCE_BACKEND:-off}
      - TEMP_DIR=/tmp/heimdex
    volumes:
      - /tmp/heimdex:/tmp/heimdex
    command: python -m dramatiq src.tasks --processes 1 --threads 2

  # API service for testing admin endpoint
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}
      - OPENSEARCH_URL=${OPENSEARCH_URL:-}
      - CLIP_ENABLED=${CLIP_ENABLED:-false}
      - SEARCH_DEBUG=${SEARCH_DEBUG:-false}

  # CLI runner for manual reprocessing
  cli-reprocess:
    build:
      context: .
      dockerfile: services/worker/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}
      - EMBEDDING_HMAC_SECRET=${EMBEDDING_HMAC_SECRET:-}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      - OPENSEARCH_URL=${OPENSEARCH_URL:-}
      - CLIP_ENABLED=${CLIP_ENABLED:-false}
      - CLIP_INFERENCE_BACKEND=${CLIP_INFERENCE_BACKEND:-off}
      - TEMP_DIR=/tmp/heimdex
    volumes:
      - /tmp/heimdex:/tmp/heimdex
    # Don't start automatically - used for manual CLI runs
    profiles:
      - manual

networks:
  default:
    name: heimdex-reprocess-network
