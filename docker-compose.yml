services:
  # Redis for Dramatiq message broker
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # OpenSearch for BM25 lexical search (hybrid search)
  opensearch:
    build:
      context: ./services/opensearch
      dockerfile: Dockerfile
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # OpenSearch Dashboards (optional, for debugging)
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch:9200"]
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "5601:5601"
    depends_on:
      opensearch:
        condition: service_healthy

  # API Service
  api:
    build:
      context: .
      dockerfile: ./services/api/Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Supabase configuration
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}

      # Database
      DATABASE_URL: ${DATABASE_URL}

      # Redis
      REDIS_URL: redis://redis:6379/0

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # API config
      API_CORS_ORIGINS: http://localhost:3000,http://frontend:3000

      # OpenSearch (hybrid search)
      OPENSEARCH_URL: http://opensearch:9200
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Worker Service
  worker:
    build:
      context: .
      dockerfile: ./services/worker/Dockerfile
    environment:
      # Supabase configuration
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}

      # Database
      DATABASE_URL: ${DATABASE_URL}

      # Redis
      REDIS_URL: redis://redis:6379/0

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # Processing config
      TEMP_DIR: /tmp/heimdex

      # OpenSearch (hybrid search)
      OPENSEARCH_URL: http://opensearch:9200
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Frontend Service
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
        NEXT_PUBLIC_API_URL: http://localhost:8000
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      NEXT_PUBLIC_API_URL: http://localhost:8000
    depends_on:
      - api
    restart: unless-stopped

volumes:
  redis_data:
  opensearch-data:
